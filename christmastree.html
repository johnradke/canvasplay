<html>
<head>
</head>
<body>
<canvas id="canvas" width="500" height="500">
</canvas>
<script src="script/bedrock.js"></script>
<script src="script/canvasproxy.js"></script>
<script >

$.go(function() {
    var cv = new CanvasProxy($.id('canvas'), { centerOrigin: true});

    function circle(startOffset, height, radius, rgbArray) {
        var speed = 5000; // ms per cycle
        
        function _getFrac (ms) {
            return ((ms + (startOffset / 1000 * speed)) % speed) / speed;
        }

        function _draw(ms) {
            var frac = _getFrac(ms);
            var x = radius * Math.sin(frac * 2 * Math.PI);
            var y = -height + (radius/4) * Math.cos(frac * 2 * Math.PI);

            var newArray = rgbArray.mult(100 + Math.floor(50 * (Math.cos(frac * 2 * Math.PI) + 1)));

            var color = rgba(newArray[0], newArray[1], newArray[2], 1)

            cv.drawCircle(x, y, 5, color, true);
        };

        function _getZ(ms) {
            return Math.round(1000*Math.cos(_getFrac(ms) * 2 * Math.PI));
        }

        return {
            draw: _draw,
            getZ: _getZ
        }
    }

    var stem = {
        draw: function() {
            cv.lineWidth = 10;
            cv.drawPath([{x: 0, y: -240}, {x: 0, y:240}], rgba(127, 82, 23, 1));
        },
        getZ: function() {
            return 0;
        }
    }

    var sprites = [stem];

    $.range(-200, 240).forEach(function(height){
        var offsets = [];
        $.range((250 - height) / 50).forEach(function(obj) {
            var color = [0, 1, 0];
            var rand = $.rand(20);

            if (rand === 6) {
                color = [1, 0, 0];
            }
            if (rand === 5) {
                color = [0, 0, 1];
            }
            if (rand === 7) {
                color = [1, 0, 1];
            }

            var offset = $.rand(1000);

            // keep the offsets distinct to prevent z-fighting
            while (offsets.indexOf(offset) > -1) {
                offset = $.rand(1000);
            }

            offsets.push(offset);

            sprites.push(circle(offset, height, (250 - height) / 2.5, color));
        });
    });

    cv.eachFrame = function() {
        cv.clear();
        
        var ms = new Date().getTime();
        sprites = sprites.sort(function(a, b) {
            return a.getZ(ms) - b.getZ(ms);
        });

        sprites.forEach(function(sprite) {
            sprite.draw(ms);
        });
    };

    cv.startAnimation();
})
</script>
</body>
</html>